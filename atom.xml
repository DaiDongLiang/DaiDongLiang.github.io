<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MagicWolf</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://magicwolf.xyz/"/>
  <updated>2016-12-20T09:50:01.041Z</updated>
  <id>http://magicwolf.xyz/</id>
  
  <author>
    <name>MagicWolf</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Spring MVC系列（一）利用切面编程进行加密</title>
    <link href="http://magicwolf.xyz/2016/12/18/spring-mvc-one/"/>
    <id>http://magicwolf.xyz/2016/12/18/spring-mvc-one/</id>
    <published>2016-12-17T16:00:00.000Z</published>
    <updated>2016-12-20T09:50:01.041Z</updated>
    
    <content type="html"><![CDATA[<p>最近在做基于Oauth2.0协议的认证系统，整体认证流程已经完成，但是Oauth2.0需要HTTPS配合，否则会有安全隐患。由于没有HTTPS证书，所以只有自己进行数据加密。利用切面编程可以在不改变原有模块的情况下加入加密功能，与原有模块解耦。</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>以一个常见的场景举例。</p>
<ul>
<li>客户端传个服务器一个用户ID和token值，服务器验证token并根据ID返回数据  </li>
<li>传来的token参数已经加密，服务器要根据用户ID查出AES密钥，进行解密，再验证token，并把返回信息加密。<a id="more"></a>
<h2 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h2>使用Spring MVC构建这个简单的接口。</li>
</ul>
<h3 id="UserController类"><a href="#UserController类" class="headerlink" title="UserController类"></a>UserController类</h3><p>使用<code>@Controller</code>注解声明控制器。<code>@RequestMapping</code>注解映射地址。<code>@Autowired</code>注解自动注入<code>UserService</code>对象，执行业务逻辑。<code>@RequestParam</code>注解绑定参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="meta">@Qualifier</span>(<span class="string">"userService"</span>)</div><div class="line">	<span class="keyword">private</span> UserService userService;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="meta">@RequestMapping</span>(value=<span class="string">"/message"</span>,method=RequestMethod.GET)</div><div class="line">	<span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">UserModel <span class="title">message</span><span class="params">(@RequestParam(<span class="string">"id"</span>)</span> String id,@<span class="title">RequestParam</span><span class="params">(<span class="string">"token"</span>)</span> String token)</span>&#123;</div><div class="line">		<span class="keyword">return</span> userService.message(id,token);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="UserService类"><a href="#UserService类" class="headerlink" title="UserService类"></a>UserService类</h3><p><code>@Service</code>注解声明服务类。从<code>UserDao</code>中查到用户信息并返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span>(<span class="string">"userService"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="meta">@Qualifier</span>(<span class="string">"userDao"</span>)</div><div class="line">	<span class="keyword">private</span> UserDao userDao;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> UserModel <span class="title">message</span><span class="params">(String id,String token)</span></span>&#123;</div><div class="line">		</div><div class="line">		<span class="comment">/*验证token......*/</span></div><div class="line">		<span class="keyword">return</span> userDao.getUserById(id);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="UserDao类"><a href="#UserDao类" class="headerlink" title="UserDao类"></a>UserDao类</h3><p><code>@Repository</code>注解声明仓库类。此处模拟一个数据返回。（Spring MVC 提供的JDBC工具类还是不错的）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Repository</span>(<span class="string">"userDao"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> UserModel <span class="title">getUserById</span><span class="params">(String id)</span></span>&#123;</div><div class="line">		UserModel user=<span class="keyword">new</span> UserModel();</div><div class="line">		user.setUserName(<span class="string">"MagicWolf"</span>);</div><div class="line">		user.setEmail(<span class="string">"dai.dongliang@foxmail.com"</span>);</div><div class="line">		<span class="keyword">return</span> user;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="UserModel类"><a href="#UserModel类" class="headerlink" title="UserModel类"></a>UserModel类</h3><p>一个简单的POJO对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModel</span></span>&#123;</div><div class="line">	<span class="keyword">private</span> String userName;</div><div class="line">	<span class="keyword">private</span> String email;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> userName;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.userName = userName;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getEmail</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> email;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmail</span><span class="params">(String email)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.email = email;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><p>配置Spring MVC。此处简化了些配置，没有使用模块化配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">	<span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></div><div class="line">	<span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"3.0"</span>&gt;</div><div class="line">	<span class="comment">&lt;!--字符过滤器--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div><div class="line">	    	</div><div class="line">	<span class="comment">&lt;!-- spring 前端控制器 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>WebTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>WebTest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="WebTest-Servlet-xml"><a href="#WebTest-Servlet-xml" class="headerlink" title="WebTest-Servlet.xml"></a>WebTest-Servlet.xml</h3><p>Spring配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">    <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">        http://www.springframework.org/schema/beans</div><div class="line">        http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">        http://www.springframework.org/schema/aop</div><div class="line">        http://www.springframework.org/schema/aop/spring-aop.xsd</div><div class="line">        http://www.springframework.org/schema/mvc</div><div class="line">        http://www.springframework.org/schema/mvc/spring-mvc.xsd</div><div class="line">        http://www.springframework.org/schema/context</div><div class="line">        http://www.springframework.org/schema/context/spring-context.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 注册注解驱动特性 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span>  </div><div class="line">    <span class="comment">&lt;!-- 开启注解装配 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span> /&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 扫描注解 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.magicwolf"</span> /&gt;</span>   	</div><div class="line">    <span class="comment">&lt;!-- 内容视图解析器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.ContentNegotiatingViewResolver"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mediaTypes"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"json"</span> <span class="attr">value</span>=<span class="string">"application/json"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultContentType"</span> <span class="attr">value</span>=<span class="string">"application/json"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 视图解析器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/jsp/"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在浏览器输入<code>http://localhost:8080/WebTest/user/message?id=123&amp;token=123</code><br>可以看到返回了用户信息，基本功能完成。</p>
<h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"userName"</span>: <span class="string">"MagicWolf"</span>,</div><div class="line">    <span class="attr">"email"</span>: <span class="string">"dai.dongliang@foxmail.com"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="解密-加密功能"><a href="#解密-加密功能" class="headerlink" title="解密/加密功能"></a>解密/加密功能</h2><h3 id="方案一：过滤器-拦截器"><a href="#方案一：过滤器-拦截器" class="headerlink" title="方案一：过滤器+拦截器"></a>方案一：过滤器+拦截器</h3><ul>
<li>Spring MVC中有拦截器可以在处理方法执行前拦截，其实内部也是用的切面编程。  </li>
<li>由于`HttpServletRequest``没有提供改变请求参数的接口，所以需要包装一下，使用自己的Request。</li>
</ul>
<h4 id="HttpRequestWapperFilter类"><a href="#HttpRequestWapperFilter类" class="headerlink" title="HttpRequestWapperFilter类"></a>HttpRequestWapperFilter类</h4><p>在<code>doFilter</code>方法中，使用自己的包装类替换<code>HttpServletRequest</code></p>
<pre><code>public class HttpRequestWapperFilter implements Filter{
    @Override
    public void destroy() {}
    @Override
    public void init(FilterConfig arg0) throws ServletException {}

    @Override
    public void doFilter(ServletRequest request, ServletResponse response,
            FilterChain chain) throws IOException, ServletException {
        request=new HttpRequestWapper((HttpServletRequest)request);
        chain.doFilter(request, response);
    }
}
</code></pre><h4 id="HttpRequestWapper类"><a href="#HttpRequestWapper类" class="headerlink" title="HttpRequestWapper类"></a>HttpRequestWapper类</h4><ul>
<li>继承HttpServletRequestWrapper。  </li>
<li>Spring MVC在绑定参数过程中使用<code>getParameterValues</code>方法，所以我们重写这个方法。  </li>
<li>增加一个私有属性key表示加密密钥。  </li>
<li>如果不怕麻烦完全可以在这一步从<code>request</code>中得到ID参数，然后写JDBC操作查到用户密钥进行解密。但是我想在Spring中使用之前写好的数据库操作类<code>UserDao</code>，所以把查密钥这一步放到了拦截器中。　　</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">   <span class="class"><span class="keyword">class</span> <span class="title">HttpRequestWapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span></span>&#123;</div><div class="line">       <span class="keyword">private</span> String key;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">HttpRequestWapper</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">		<span class="keyword">super</span>(request);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">public</span> String[] getParameterValues(String name) &#123;</div><div class="line">		String[] strs=<span class="keyword">super</span>.getParameterValues(name);</div><div class="line">		<span class="keyword">if</span>(name.equals(<span class="string">"id"</span>))&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;strs.length;i++)</div><div class="line">				strs[i]=AESCodec.decrypt(strs[i], key);<span class="comment">//AES解密</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> strs;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.key = key;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="UserMessageInterceptor类"><a href="#UserMessageInterceptor类" class="headerlink" title="UserMessageInterceptor类"></a>UserMessageInterceptor类</h4><p>在拦截器里可以方便的使用SPring注入<code>UserDao</code>。在<code>preHandle</code>方法中设置key的值<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">    public class UserMessageInterceptor extends HandlerInterceptorAdapter&#123;</div><div class="line">    	@Autowired</div><div class="line">    	@Qualifier("userDao")</div><div class="line">    	private UserDao userDao;</div><div class="line">    	</div><div class="line">    	@Override</div><div class="line">    	public boolean preHandle(HttpServletRequest request,</div><div class="line">    			HttpServletResponse response, Object handler) throws Exception &#123;</div><div class="line">    		String key=userDao.getAESKeyByUserId(request.getParameter("id"));</div><div class="line">    		((HttpRequestWapper)request).setKey(key);</div><div class="line">    		return true;</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line">```    </div><div class="line">#### web.xml</div><div class="line">在配置文件中加入包装类的过滤器</div><div class="line">``` xml</div><div class="line">    	&lt;filter&gt;</div><div class="line">    	   &lt;filter-name&gt;HttpWapperFilter&lt;/filter-name&gt;</div><div class="line">    	   &lt;filter-class&gt;com.magicwolf.HttpRequestWapperFilter&lt;/filter-class&gt;</div><div class="line">    	&lt;/filter&gt;</div><div class="line">    	&lt;filter-mapping&gt;</div><div class="line">    	   &lt;filter-name&gt;HttpWapperFilter&lt;/filter-name&gt;</div><div class="line">    	&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">    	&lt;/filter-mapping&gt;</div></pre></td></tr></table></figure></p>
<h4 id="WebTest-Servlet-xml-1"><a href="#WebTest-Servlet-xml-1" class="headerlink" title="WebTest-Servlet.xml"></a>WebTest-Servlet.xml</h4><p>加入拦截器配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span>    </div><div class="line">   <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span>    </div><div class="line">       <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">"/user/**"</span> /&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.magicwolf.UserMessageInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    </div><div class="line">   <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><ul>
<li>在浏览器输入<code>http://localhost:8080/WebTest/user/message?id=123&amp;token=0lCQPVTc8WCNP2FxocbC7Q==</code>  </li>
<li>此时token值已经经过加密，在控制器message方法中打印token参数，可以成功打印出123</li>
</ul>
<h4 id="返回信息加密"><a href="#返回信息加密" class="headerlink" title="返回信息加密"></a>返回信息加密</h4><p>返回信息的加密原理上跟解密一样，而且本文重点也不在这，所以这里就简单说一下思路。</p>
<ul>
<li>包装<code>HttpServletResponse</code>对象，添加一个<code>toByteArray()</code>方法返回输出缓冲区的内容</li>
<li>在过滤器中先调用<code>doFilter</code>执行请求，之后使用<code>toByteArray()</code>方法得到缓冲区字节，在进行加密。  </li>
</ul>
<h3 id="方案二：切面编程"><a href="#方案二：切面编程" class="headerlink" title="方案二：切面编程"></a>方案二：切面编程</h3><p>使用了Spring的AOP后，解决这个问题就变的轻松加愉快了。关于AOP这里就不做详细描述了。</p>
<h4 id="AESAspect类"><a href="#AESAspect类" class="headerlink" title="AESAspect类"></a>AESAspect类</h4><p>声明切面。</p>
<ul>
<li><code>@Component</code>注解用于声明组件。</li>
<li><code>@Aspect</code>注解用于声明切面。</li>
<li><code>@Pointcut</code>注解声明切点，括号里是切点表达式，这里定位到UserService类的message方法</li>
<li><code>@Around</code>声明是环绕通知方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span>(<span class="string">"AESAspect"</span>)</div><div class="line"><span class="meta">@Aspect</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AESAspect</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="meta">@Qualifier</span>(<span class="string">"userDao"</span>)</div><div class="line">	<span class="keyword">private</span> UserDao userDao;</div><div class="line"></div><div class="line">	<span class="meta">@Pointcut</span>(<span class="string">"execution(* com.magicwolf.UserService.message(..))"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messagePointcut</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Around</span>(<span class="string">"messagePointcut()"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> UserModel <span class="title">messagePointcut</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		Object[] args = point.getArgs();</div><div class="line">		String id = (String) args[<span class="number">0</span>];</div><div class="line">		String key = userDao.getAESKeyByUserId(id);</div><div class="line">		AESCodec.decrypt((String) args[<span class="number">1</span>], key);</div><div class="line">		<span class="comment">// 执行</span></div><div class="line">		UserModel result = (UserModel) point.proceed(args);</div><div class="line">		<span class="comment">// 返回值加密</span></div><div class="line">		result.encrypt(key);</div><div class="line">		<span class="comment">// 返回结果</span></div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="UserModel类-1"><a href="#UserModel类-1" class="headerlink" title="UserModel类"></a>UserModel类</h4><p>在UserModel中添加一个加密成员变量的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encrypt</span><span class="params">(String key)</span></span>&#123;</div><div class="line">	<span class="keyword">this</span>.userName=AESCodec.encrypt(userName, key);</div><div class="line">	<span class="keyword">this</span>.email=AESCodec.encrypt(email, key);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="WebTest-servlet-xml"><a href="#WebTest-servlet-xml" class="headerlink" title="WebTest-servlet.xml"></a>WebTest-servlet.xml</h4><p>更改代理方式，使用cglib代理来替换JDK代理。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line">```   </div><div class="line">#### 测试</div><div class="line">在浏览器中输入`http://localhost:8080/WebTest/user/message?id=123&amp;token=0lCQPVTc8WCNP2FxocbC7Q==`  </div><div class="line">##### 返回值</div><div class="line">此时返回值已经加密</div><div class="line">``` json</div><div class="line">    &#123;</div><div class="line">    userName: "U/6CJMzF1IRV/HpEjDJPEQ==",</div><div class="line">    email: "kQAV7t4611RYADmDC69odyQmES+MXv+p4OmYMC8fSoU="</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>通过两种方法的对比可以看到，使用切面编程，模块间耦合程度很低，架构清晰，易于实现。</li>
<li>但是这仅仅是一个小小的测试，如果项目规模扩大，想要织入一个功能就需要经过精心的设计，从何处切入，切点如何组织都是需要考虑的。如果没设计好，切面部位或许将成为一个重灾区（认证系统里的加密切面就显得有些凌乱，庞杂，但我也不知道该如何优化）</li>
<li>还有个小问题，拦截器里应该是可以直接对<code>request</code>对象进行包装的，可是我在拦截器里进行包装却没有效果，可能是此处的<code>request</code>对象只是一个拷贝吧。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;最近在做基于Oauth2.0协议的认证系统，整体认证流程已经完成，但是Oauth2.0需要HTTPS配合，否则会有安全隐患。由于没有HTTPS证书，所以只有自己进行数据加密。利用切面编程可以在不改变原有模块的情况下加入加密功能，与原有模块解耦。&lt;/p&gt;
&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;以一个常见的场景举例。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;客户端传个服务器一个用户ID和token值，服务器验证token并根据ID返回数据  &lt;/li&gt;
&lt;li&gt;传来的token参数已经加密，服务器要根据用户ID查出AES密钥，进行解密，再验证token，并把返回信息加密。
    
    </summary>
    
      <category term="Java" scheme="http://magicwolf.xyz/categories/Java/"/>
    
    
      <category term="Spring" scheme="http://magicwolf.xyz/tags/Spring/"/>
    
  </entry>
  
</feed>
